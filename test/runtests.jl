using EGGO
using Test
using EGGO.IMAS

nb = 101
nw = 129
b0 = 2.0
r0 = 1.6955
pend = 0.1

@testset "test_efit01" begin
    x = [1.09559171, 1.0997446376, 1.1070618348, 1.1175362682999999, 1.1308035831999999, 1.1462708645, 1.1618525741999999, 1.1748229521, 1.1938695924, 1.208962951, 1.226595503, 1.2436285322, 1.2603981636, 1.2776812111, 1.2946356166, 1.309698407, 1.3281952508, 1.3415813081, 1.354473056, 1.3868513145, 1.43234375, 1.4749765625, 1.5115, 1.5575859375, 1.59225, 1.629264015, 1.6710031426, 1.7095234375, 1.7441875, 1.7788515625, 1.8135156250000002, 1.8481796875, 1.88284375, 1.9175078125, 1.945799357, 1.97481647, 2.0056947116, 2.0339704028, 2.06346875, 2.086578125, 2.1096875, 2.1327968750000004, 2.15590625, 2.179015625, 2.2001536684, 2.217257788, 2.2349671081999998, 2.2539269399000004, 2.2700427984, 2.2831342743, 2.29447733, 2.3007727865, 2.2985730319999997, 2.28932236, 2.27537713, 2.26318817, 2.24475263, 2.2282805774999996, 2.2090312500000002, 2.1878476362000003, 2.1694483840000003, 2.149598575, 2.12721739, 2.1014536774, 2.072722168, 2.047265625, 2.0185781249999994, 1.9873986125999998, 1.9614681795999998, 1.9278671875, 1.8932031249999999, 1.8585390625000002, 1.8238750000000001, 1.7865177448, 1.7462259225999999, 1.7066015625, 1.6703437499999998, 1.6241249999999996, 1.5779062499999996, 1.5316874999999999, 1.48546875, 1.4454921874999997, 1.4108281249999997, 1.3780797244999998, 1.351107168, 1.3217171325, 1.2978439504, 1.2767148960999999, 1.2573982568000002, 1.2381546668, 1.2177480379999999, 1.1975857947, 1.182617962, 1.1625175254999998, 1.1487620224, 1.134547034, 1.121177226, 1.1101826154, 1.1018582046, 1.0962396599, 1.09559171, 0.0, 0.08700000000000001, 0.1555, 0.22075, 0.28600000000000003, 0.35099467675, 0.4104309939, 0.45675000000000004, 0.522, 0.57218528669, 0.6295549229, 0.6848864054, 0.7392743632, 0.79590334712, 0.8527927246400001, 0.90375, 0.969, 1.0186794792, 1.0682557061999998, 1.0800915083, 1.067447848, 1.0555178317, 1.0444215632, 1.0298720099, 1.0179782311999999, 1.0040844275, 0.98708481596, 0.9699926525799999, 0.9528818285199999, 0.93403012572, 0.9132756059999999, 0.8903396655, 0.86469505932, 0.8363221227999998, 0.81120005558, 0.78280078805, 0.75001007972, 0.71655532232, 0.6782200468399999, 0.6443729700199998, 0.6065020579999999, 0.5642903279599999, 0.51716010578, 0.46468993953000004, 0.4122795048000001, 0.3663453183, 0.3159560795599999, 0.2574032334199997, 0.20136560271999993, 0.14757272764, 0.07500000000000023, 0.003888867154000171, -0.054363408007999894, -0.13325000000000006, -0.1985000000000002, -0.24374816975000022, -0.30441116180000044, -0.3550996140500004, -0.40947549072, -0.4656649635900001, -0.5100000000000001, -0.5534999999999999, -0.5969999999999999, -0.6405, -0.6828329336800001, -0.7163802308000001, -0.7491309296600003, -0.7814770833500002, -0.8051318419200003, -0.83292756801, -0.8576806923000001, -0.8792819401699999, -0.8981352902399999, -0.91548856884, -0.9313817735800001, -0.94447484125, -0.9537477083200001, -0.9626707641400001, -0.96699025372, -0.96659880543, -0.959736525, -0.9473212784099999, -0.9282227074599998, -0.9017757330699997, -0.871, -0.8274999999999999, -0.7839999999999998, -0.7405, -0.6970000000000002, -0.6503358114600001, -0.5973489954, -0.5414999999999999, -0.49699999999999966, -0.4317499999999995, -0.3823828279999995, -0.32462690999999927, -0.26099999999999984, -0.19574999999999998, -0.12400000000000036, -0.043500000000000094, 0.0, -2.8693022500000005, -2.83117579, -2.79329281, -2.7556533, -2.71825727, -2.68110472, -2.64419565, -2.60753006, -2.57110794, -2.5349293, -2.49899413, -2.46330245, -2.42785424, -2.3926495, -2.35768825, -2.32297047, -2.28849617, -2.25426535, -2.220278, -2.18653413, -2.1530337400000006, -2.11977683, -2.08676339, -2.05399343, -2.02146695, -1.9891839400000002, -1.95714441, -1.92534836, -1.8937957900000002, -1.86248669, -1.8314210700000002, -1.8005989300000003, -1.77002026, -1.7396850800000003, -1.70959337, -1.6797451299999997, -1.65014038, -1.6207791, -1.5916613, -1.56278697, -1.53415612, -1.50576875, -1.47762486, -1.44972445, -1.42206751, -1.39465405, -1.36748406, -1.34055756, -1.31387453, -1.28743497, -1.2612389, -1.2352863, -1.20957718, -1.18411154, -1.15888937, -1.13391068, -1.10917547, -1.08468374, -1.06043548, -1.0364307, -1.0126694, -0.9891515710000001, -0.965877223, -0.942846352, -0.9200589580000001, -0.8975150420000001, -0.875214602, -0.8531576399999999, -0.831344155, -0.809774148, -0.7884476170000001, -0.767364564, -0.746524988, -0.725928889, -0.705576268, -0.685467123, -0.665601456, -0.645979266, -0.626600554, -0.607465318, -0.58857356, -0.569925279, -0.551520475, -0.533359149, -0.5154413, -0.4977669270000001, -0.480336033, -0.463148615, -0.44620467500000005, -0.429504211, -0.413047225, -0.396833717, -0.380863685, -0.365137131, -0.349654054, -0.334414454, -0.319418331, -0.304665686, -0.290156518, -0.275890827, -0.261868613, -0.248089877, -0.234554618, -0.221262836, -0.20821453100000004, -0.195409703, -0.182848353, -0.17053048, -0.158456084, -0.146625165, -0.135037724, -0.123693759, -0.11259327199999998, -0.101736263, -0.09112273, -0.0807526747, -0.0706260966, -0.06074299570000001, -0.0511033721, -0.0417072256, -0.0325545564, -0.0236453645, -0.0149796497, -0.00655741217, 0.00162134814, 0.00955663122, 0.0172484371, 0.0246967657, 0.0319016171, -251684.349, -249894.236, -248104.12200000003, -246314.008, -244523.894, -242733.781, -240943.667, -239153.553, -237363.43999999997, -235573.326, -233783.212, -231993.09799999997, -230202.98500000002, -228412.871, -226622.75700000004, -224832.644, -223042.53000000003, -221252.416, -219462.303, -217672.189, -215882.07499999998, -214091.961, -212301.848, -210511.734, -208721.62000000002, -206931.50700000004, -205141.39300000004, -203351.279, -201561.165, -199771.052, -197980.938, -196190.824, -194400.711, -192610.597, -190820.483, -189030.369, -187240.25600000002, -185450.142, -183660.028, -181869.915, -180079.801, -178289.687, -176499.573, -174709.46, -172919.346, -171129.232, -169339.119, -167549.005, -165758.891, -163968.777, -162178.664, -160388.55, -158598.436, -156808.323, -155018.209, -153228.095, -151437.981, -149647.868, -147857.754, -146067.64, -144277.527, -142487.413, -140697.299, -138907.186, -137117.072, -135326.958, -133536.844, -131746.731, -129956.617, -128166.503, -126376.39, -124586.27600000001, -122796.162, -121006.048, -119215.935, -117425.82100000001, -115635.707, -113845.594, -112055.48000000001, -110265.366, -108475.252, -106685.139, -104895.02500000001, -103104.911, -101314.798, -99524.6839, -97734.5702, -95944.4564, -94154.3427, -92364.229, -90574.1153, -88784.0016, -86993.8879, -85203.7742, -83413.6605, -81623.54680000001, -79833.433, -78043.3193, -76253.2056, -74463.0919, -72672.9782, -70882.8645, -69092.7508, -67302.6371, -65512.5234, -63722.4096, -61932.29589999999, -60142.1822, -58352.06850000001, -56561.95480000001, -54771.8411, -52981.72740000001, -51191.6137, -49401.5, -47611.3862, -45821.2725, -44031.1588, -42241.0451, -40450.9314, -38660.8177, -36870.704, -35080.5903, -33290.4766, -31500.3628, -29710.2491, -27920.135400000003, -26130.021700000005, -24339.908, -22549.7943, -10483.764092115976, -10406.591562771071, -10380.03968422253, -10245.780286354311, -10841.642475001427, -10303.48090229303]
    Rb_target = x[1:nb]
    Zb_target = x[nb+1:2*nb]
    Rb_target[end] = Rb_target[1]
    Zb_target[end] = Zb_target[1]
    ffp_target = x[2*nb+1:2*nb+nw]
    pp_target = x[2*nb+nw+1:2*nb+2*nw]

    model_name = :d3d_efit01
    green = EGGO.get_greens_function_tables(model_name)
    basis_functions = EGGO.get_basis_functions(model_name)
    basis_functions_1d, bf1d_itp = EGGO.get_basis_functions_1d(model_name)
    wall = EGGO.get_wall(model_name)
    NNmodel = EGGO.get_model(model_name)
    model = NNmodel[:model]
    coils = nothing 
    Ip_target = 0.0
    use_vacuum_fields = false
    
    pp_fit, ffp_fit = EGGO.fit_ppffp(pp_target, ffp_target, basis_functions_1d)
    
    Jt,psirz, Ip = EGGO.predict_model_from_boundary(Rb_target,Zb_target,pp_fit,ffp_fit,NNmodel, green, basis_functions,coils,Ip_target,use_vacuum_fields)
    
    Ψaxis, Raxis, Zaxis, Ψbnd, ffp, pp = EGGO.get_ΨaxisΨbndffppp(psirz, green, basis_functions,basis_functions_1d, bf1d_itp, wall, pp_fit, ffp_fit)
    dd = IMAS.dd()
    eqt = resize!(dd.equilibrium.time_slice)
    EGGO.fill_eqt(eqt, psirz, green, wall, pp, ffp, b0, r0, pend,Ψbnd,Ψaxis,Raxis,Zaxis)

    @test Jt !== nothing
    @test psirz !== nothing
    @test Ip !== nothing
end

@testset "test_efit01_coils" begin
    x = [-3.05929054, -2.99817803, -2.93762424, -2.87762916, -2.81819279, -2.75931513, -2.70099618, -2.64323595, -2.58603442, -2.52939161, -2.47330751, -2.41778211, -2.36281543, -2.30840747, -2.25455821, -2.20126766, -2.14853583, -2.09636271, -2.0447483, -1.9936925900000002, -1.94319561, -1.8932573300000002, -1.84387776, -1.79505691, -1.7467947600000002, -1.69909133, -1.6519466100000002, -1.6053606000000002, -1.5593333, -1.51386471, -1.46895484, -1.42460367, -1.38081122, -1.33757748, -1.29490245, -1.25278613, -1.21122852, -1.17022962, -1.1297894400000001, -1.08990796, -1.0505852, -1.01182115, -0.9736158080000001, -0.9359691790000001, -0.898881261, -0.862352055, -0.82638156, -0.790969776, -0.756116704, -0.721822343, -0.688086693, -0.654909755, -0.622291527, -0.590232012, -0.558731207, -0.527789114, -0.497405732, -0.46758106099999996, -0.438315102, -0.409607854, -0.381459317, -0.353869492, -0.326838378, -0.300365975, -0.274452284, -0.249097303, -0.224301035, -0.20006347700000002, -0.176384631, -0.153264496, -0.130703072, -0.10870036, -0.0872563591, -0.0663710694, -0.0460444911, -0.026276624000000002, -0.007067468290000001, 0.0115829761, 0.029674709300000005, 0.0472077311, 0.0641820416, 0.0805976408, 0.09645452870000001, 0.11175270500000001, 0.126492171, 0.140672924, 0.154294967, 0.16735829800000002, 0.179862918, 0.191808827, 0.20319602500000003, 0.214024511, 0.22429428600000004, 0.23400534900000003, 0.243157701, 0.251751342, 0.259786272, 0.26726249, 0.274179997, 0.280538792, 0.286338877, 0.29158025, 0.296262911, 0.300386862, 0.303952101, 0.306958629, 0.309406445, 0.31129555, 0.312625944, 0.313397627, 0.313610598, 0.313264858, 0.312360406, 0.310897244, 0.30887537, 0.306294784, 0.303155488, 0.29945748, 0.295200761, 0.29038533, 0.285011188, 0.279078335, 0.272586771, 0.265536495, 0.257927508, 0.249759809, 0.24103340000000004, 0.231748278, 0.221904446, -292086.832, -291584.589, -291082.346, -290580.104, -290077.861, -289575.618, -289073.375, -288571.133, -288068.89, -287566.647, -287064.405, -286562.162, -286059.919, -285557.677, -285055.434, -284553.191, -284050.948, -283548.706, -283046.463, -282544.22, -282041.978, -281539.735, -281037.492, -280535.25, -280033.007, -279530.764, -279028.521, -278526.279, -278024.036, -277521.793, -277019.551, -276517.308, -276015.065, -275512.823, -275010.58, -274508.337, -274006.094, -273503.852, -273001.609, -272499.366, -271997.124, -271494.881, -270992.638, -270490.396, -269988.153, -269485.91, -268983.667, -268481.425, -267979.182, -267476.939, -266974.697, -266472.454, -265970.211, -265467.969, -264965.726, -264463.483, -263961.24, -263458.998, -262956.755, -262454.512, -261952.27, -261450.02700000003, -260947.784, -260445.542, -259943.29899999997, -259441.056, -258938.813, -258436.571, -257934.32800000004, -257432.08500000002, -256929.843, -256427.59999999998, -255925.357, -255423.11500000002, -254920.872, -254418.629, -253916.38600000003, -253414.144, -252911.90100000004, -252409.65799999997, -251907.41600000003, -251405.173, -250902.93, -250400.688, -249898.445, -249396.202, -248893.95899999997, -248391.71700000003, -247889.47400000002, -247387.231, -246884.989, -246382.746, -245880.503, -245378.261, -244876.01800000004, -244373.77500000002, -243871.532, -243369.29, -242867.047, -242364.804, -241862.562, -241360.319, -240858.07600000003, -240355.834, -239853.59100000001, -239351.348, -238849.105, -238346.863, -237844.62, -237342.37700000004, -236840.135, -236337.892, -235835.649, -235333.40700000004, -234831.16400000002, -234328.921, -233826.67800000004, -233324.436, -232822.193, -232319.95, -231817.70800000004, -231315.46500000003, -230813.222, -230310.979, -229808.737, -229306.494, -228804.251, -228302.009, -227799.76600000003, -21009.964005261743, -20777.635055556715, -20750.819688510797, -20538.19276640497, -21517.19671605535, -20520.544173424256, -48069.01155577911, -105412.70627977072, -65450.61476093829, 168667.12757848273, 80766.94228412876, -199019.7140576596, -108107.73956413682, 48950.34227706412, -54646.223644157704, -83425.29587747896, -120694.5582073578, -65136.59821802952, 151868.37843217276, 112168.53997400288, -197901.40842632405, -128182.81089571706, 43513.825161639536, -55231.54902816614]
    ffp_target = x[1:nw]
    pp_target = x[nw+1:2*nw]
    fcurrt_target = x[2*nw+7:end]
    ecurrt_target = zeros(6)
    model_name = :d3d_efit01efit02cake02_coils
    green = EGGO.get_greens_function_tables(model_name)
    basis_functions = EGGO.get_basis_functions(model_name)
    basis_functions_1d, bf1d_itp = EGGO.get_basis_functions_1d(model_name)
    wall = EGGO.get_wall(model_name)
    NNmodel = EGGO.get_model(model_name)

    model = NNmodel[:model]

    pp_fit, ffp_fit = EGGO.fit_ppffp(pp_target, ffp_target, basis_functions_1d)

    Jt, psirz, Ip = EGGO.predict_model_from_coils(pp_fit, ffp_fit, ecurrt_target,fcurrt_target, NNmodel, green, basis_functions)
    Ψaxis, Raxis, Zaxis, Ψbnd, ffp,pp = EGGO.get_ΨaxisΨbndffppp(psirz, green, basis_functions,basis_functions_1d, bf1d_itp, wall, pp_fit, ffp_fit)


    # fill out eqt quantities
    dd = IMAS.dd()
    eqt = resize!(dd.equilibrium.time_slice)
    EGGO.fill_eqt(eqt, psirz, green, wall, pp, ffp, b0, r0, pend,Ψbnd,Ψaxis,Raxis,Zaxis)

    @test Jt !== nothing
    @test psirz !== nothing
    @test Ip !== nothing
end

@testset "test_efit01efit02cake02" begin
    x = [1.0605924129486084, 1.0608896017074585, 1.0663938522338867, 1.0763258576393127, 1.089898157119751, 1.106051743030548, 1.1222374200820924, 1.1372824311256409, 1.1531906366348266, 1.17087482213974, 1.1853125095367432, 1.2006852149963378, 1.218287706375122, 1.2335846662521361, 1.2507448673248291, 1.2689452767372131, 1.2914233446121215, 1.3205092549324036, 1.355312466621399, 1.403124988079071, 1.4509375095367432, 1.4987500309944153, 1.5359374761581421, 1.5717968702316285, 1.6153075218200683, 1.6565322875976562, 1.6926562309265136, 1.728515648841858, 1.7643750429153442, 1.7995216488838195, 1.8289666175842285, 1.8592872738838195, 1.8945312738418578, 1.9289194464683532, 1.9574405908584596, 1.9888281226158142, 2.019374942779541, 2.044689416885376, 2.0730913639068604, 2.102062153816223, 2.127997398376465, 2.1511905670166014, 2.172341537475586, 2.1916290521621704, 2.2119120597839355, 2.2310010194778442, 2.248103475570679, 2.2624563694000246, 2.2705305576324464, 2.270718479156494, 2.261093854904175, 2.248667073249817, 2.2301867485046385, 2.2133516550064085, 2.192031240463257, 2.170197367668152, 2.149298667907715, 2.126526713371277, 2.101067686080933, 2.073360633850098, 2.048593759536743, 2.02428457736969, 1.990066719055176, 1.9635937929153442, 1.9317187786102294, 1.8995608687400818, 1.8697542905807496, 1.8374218702316285, 1.801562476158142, 1.7658294439315794, 1.7311066389083862, 1.6980594635009767, 1.662781071662903, 1.625009858608246, 1.5871647119522097, 1.5505468845367432, 1.5146875143051148, 1.4788281679153443, 1.4404259204864502, 1.3943384885787966, 1.357968807220459, 1.3221093893051146, 1.280711030960083, 1.260015070438385, 1.2467604875564575, 1.235423743724823, 1.225132942199707, 1.2145055651664733, 1.2027714014053346, 1.1897595405578614, 1.1756504774093628, 1.1607079982757567, 1.1481845140457154, 1.1347704529762268, 1.1197039842605592, 1.1043232083320618, 1.0899749755859376, 1.0775456547737121, 1.067907977104187, 1.061852514743805, 1.0605924129486084, -0.05000000074505806, 0.040000000596046456, 0.11000000014901161, 0.17750000208616257, 0.24500000476837158, 0.3125, 0.3747981011867523, 0.430896681547165, 0.4899999976158142, 0.5560540735721587, 0.6105406284332275, 0.6685540735721588, 0.7350000023841857, 0.7913967251777649, 0.8486552715301514, 0.9000000059604644, 0.9450000166893006, 0.9834775567054749, 1.006093430519104, 1.0171737670898438, 1.0148380994796753, 1.0042214870452881, 0.9928232908248902, 0.9791854500770569, 0.9597741961479187, 0.9393350481987, 0.9192203879356384, 0.8972308874130248, 0.8732836365699768, 0.8478904962539674, 0.824999988079071, 0.7998602330684662, 0.7686789989471436, 0.7359746217727662, 0.7072233438491821, 0.6729281842708587, 0.6372743964195252, 0.6047218382358552, 0.5649999856948852, 0.5199999779462814, 0.4749999940395355, 0.43000001013278966, 0.3850000023841859, 0.3399999916553498, 0.2869778692722322, 0.23081489652395248, 0.1700000017881392, 0.10250000022351731, 0.030000000447035234, -0.05868589170277084, -0.13685891032218933, -0.19368589371442763, -0.26000000536441786, -0.31233201026916513, -0.36999034881591797, -0.423881471157074, -0.4699999928474428, -0.515000003576279, -0.5600000143051144, -0.603956478834152, -0.639564573764801, -0.671456468105316, -0.712974989414215, -0.7432445347309113, -0.7770223259925843, -0.8093024492263794, -0.8374802708625794, -0.866409808397293, -0.8965201258659363, -0.9245087027549745, -0.949999988079071, -0.972500020265579, -0.9950000047683716, -1.0174999833106992, -1.0385538578033446, -1.0576683282852173, -1.0752827644348144, -1.0918086409568786, -1.1081947326660155, -1.126527726650238, -1.1402772665023804, -1.1525838851928711, -1.1658611536026, -1.120651602745056, -1.0549999952316287, -0.9874999821186069, -0.919999992847443, -0.8525000035762789, -0.7850000143051148, -0.7175000190734866, -0.6499999761581421, -0.5824999868869778, -0.527599036693573, -0.46972463130950914, -0.40499999523162844, -0.3375000059604645, -0.27000000476837205, -0.20249999761581458, -0.13500000536441864, -0.07250000275671492, -0.05000000074505806, 1.0857765674591064, 1.0284205675125122, 0.9713146090507507, 0.9148002862930298, 0.8592207431793213, 0.8049219846725464, 0.7522538900375366, 0.7015711069107056, 0.6532343029975891, 0.6076111197471619, 0.5650774836540222, 0.5260182619094849, 0.4908289909362793, 0.4599166512489319, 0.43369922041893005, 0.41235318779945374, 0.39555004239082336, 0.3829119801521301, 0.3740735650062561, 0.36868077516555786, 0.36638984084129333, 0.3668663501739502, 0.3697841167449951, 0.37482425570487976, 0.38167428970336914, 0.3900270462036133, 0.3995799720287323, 0.4100340008735657, 0.42109283804893494, 0.4324619472026825, 0.44384774565696716, 0.45495671033859253, 0.46549442410469055, 0.47516486048698425, 0.48366934061050415, 0.49070578813552856, 0.49606043100357056, 0.49978339672088623, 0.5019684433937073, 0.5027046799659729, 0.5020768642425537, 0.5001658201217651, 0.49704840779304504, 0.4927978515625, 0.48748406767845154, 0.4811737537384033, 0.4739306569099426, 0.4658156633377075, 0.4568871557712555, 0.4472009837627411, 0.43681076169013977, 0.42576804757118225, 0.4141223728656769, 0.4019215404987335, 0.38921162486076355, 0.37603721022605896, 0.3624414801597595, 0.3484663665294647, 0.3341526687145233, 0.3195401728153229, 0.30466774106025696, 0.2895735204219818, 0.2742949426174164, 0.25886887311935425, 0.24333181977272034, 0.22771987318992615, 0.21206894516944885, 0.1964147984981537, 0.18079321086406708, 0.16524004936218262, 0.1497914046049118, 0.13448365032672882, 0.11935358494520187, 0.10443856567144394, 0.08977656811475754, 0.07540633529424667, 0.061367470771074295, 0.047700587660074234, 0.03444739803671837, 0.021650854498147964, 0.009355278685688972, -0.0023935085628181696, -0.013548054732382298, -0.024059128016233444, -0.03387556970119476, -0.04294414818286896, -0.05120938643813133, -0.05861341208219528, -0.06509577482938766, -0.07059326022863388, -0.07503972202539444, -0.07836585491895676, -0.08049900829792023, -0.08136296272277832, -0.08087770640850067, -0.07895918190479279, -0.07551905512809753, -0.07046442478895187, -0.06369758397340775, -0.055115677416324615, -0.044610437005758286, -0.032067835330963135, -0.01736775040626526, -0.0003836085379589349, 0.019017966464161873, 0.040854938328266144, 0.06475464999675751, 0.09027009457349777, 0.1169590875506401, 0.14438295364379883, 0.17210529744625092, 0.20026656985282898, 0.23097722232341766, 0.2667753994464874, 0.31021445989608765, 0.36387065052986145, 0.4303506910800934, 0.5099472999572754, 0.5945207476615906, 0.6740403771400452, 0.7384603023529053, 0.7778705358505249, 0.7868070602416992, 0.7644423842430115, 0.7100776433944702, 0.6229183077812195, 0.5020718574523926, 0.3465448319911957, 0.15524010360240936, -646553.8125, -646369.25, -646128.125, -645831.125, -645478.8125, -645071.5, -644609.4375, -644092.875, -643521.8125, -642896.125, -642215.625, -641479.9375, -640688.6875, -639841.25, -638937.0, -637975.0, -636954.3125, -635874.0, -634732.6875, -633529.125, -632261.8125, -630929.125, -629529.3125, -628060.5, -626520.5, -624907.25, -623218.25, -621451.0, -619602.75, -617670.6875, -615651.625, -613542.375, -611339.375, -609039.0625, -606637.5, -604130.5625, -601513.875, -598782.9375, -595932.8125, -592958.5, -589854.5625, -586615.375, -583234.9375, -579707.0625, -576025.0625, -572182.125, -568170.9375, -563983.75, -559612.6875, -555049.1875, -550284.375, -545309.0625, -540113.375, -534687.125, -529019.5, -523099.21875, -516914.46875, -510452.8125, -503701.1875, -496645.96875, -489272.78125, -481566.5625, -473511.59375, -465091.3125, -456288.40625, -447094.40625, -437539.0, -427660.84375, -417497.8125, -407087.28125, -396465.9375, -385670.125, -374735.71875, -363698.34375, -352593.34375, -341455.96875, -330321.40625, -319224.75, -308201.3125, -297286.5, -286515.90625, -275925.53125, -265551.75, -255431.34375, -245601.765625, -236101.015625, -226967.859375, -218241.859375, -209963.453125, -202174.109375, -194916.328125, -188233.796875, -182171.453125, -176775.625, -172094.09375, -168176.171875, -165072.921875, -162837.125, -161523.53125, -161188.859375, -161892.03125, -163694.203125, -166659.0, -170852.546875, -176343.703125, -183204.171875, -191508.65625, -201335.046875, -212764.578125, -225882.0, -240775.765625, -257538.25, -276265.90625, -297059.5625, -320075.03125, -347433.625, -383811.0625, -434072.6875, -503114.34375, -595756.125, -680025.1875, -686378.0, -655908.5625, -602309.0625, -529506.375, -441385.25, -341796.59375, -234566.328125, -123503.3984375, 3648.6083984375]
    Rb_target = x[1:nb]
    Zb_target = x[nb+1:2*nb]
    Rb_target[end] = Rb_target[1]
    Zb_target[end] = Zb_target[1]
    ffp_target = x[2*nb+1:2*nb+nw]
    pp_target = x[2*nb+nw+1:2*nb+2*nw]

    model_name = :d3d_efit01efit02cake02
    green = EGGO.get_greens_function_tables(model_name)
    basis_functions = EGGO.get_basis_functions(model_name)
    basis_functions_1d, bf1d_itp = EGGO.get_basis_functions_1d(model_name)
    wall = EGGO.get_wall(model_name)
    NNmodel = EGGO.get_model(model_name)
    model = NNmodel[:model]
    coils = nothing 
    Ip_target = 0.0
    use_vacuum_fields = false
    
    pp_fit, ffp_fit = EGGO.fit_ppffp(pp_target, ffp_target, basis_functions_1d)
    
    Jt,psirz, Ip = EGGO.predict_model_from_boundary(Rb_target,Zb_target,pp_fit,ffp_fit,NNmodel, green, basis_functions,coils,Ip_target,use_vacuum_fields)
    
    Ψaxis, Raxis, Zaxis, Ψbnd, ffp, pp = EGGO.get_ΨaxisΨbndffppp(psirz, green, basis_functions,basis_functions_1d, bf1d_itp, wall, pp_fit, ffp_fit)
    dd = IMAS.dd()
    eqt = resize!(dd.equilibrium.time_slice)
    EGGO.fill_eqt(eqt, psirz, green, wall, pp, ffp, b0, r0, pend,Ψbnd,Ψaxis,Raxis,Zaxis)

    @test Jt !== nothing
    @test psirz !== nothing
    @test Ip !== nothing
end


@testset "test_efit01efit02cake02_coils" begin
    x = [-2.6756629943847656, -2.53544282913208, -2.395742177963257, -2.2573087215423584, -2.120894193649292, -1.9872558116912842, -1.8571596145629883, -1.7313822507858276, -1.610713005065918, -1.4959566593170166, -1.3879354000091553, -1.287492036819458, -1.1954915523529053, -1.1128244400024414, -1.0404092073440552, -0.9790046811103821, -0.9282169938087463, -0.8872273564338684, -0.8552453517913818, -0.8315075635910034, -0.8152751326560974, -0.805831789970398, -0.802481472492218, -0.8045463562011719, -0.8113648891448975, -0.8222895860671997, -0.8366854786872864, -0.853927731513977, -0.8734002709388733, -0.8944934010505676, -0.916602611541748, -0.9391261339187622, -0.9614635705947876, -0.9830140471458435, -1.0031741857528687, -1.0214844942092896, -1.0379505157470703, -1.0526666641235352, -1.0657213926315308, -1.07719886302948, -1.0871779918670654, -1.0957335233688354, -1.102935791015625, -1.1088510751724243, -1.1135419607162476, -1.1170670986175537, -1.1194820404052734, -1.1208387613296509, -1.1211860179901123, -1.1205697059631348, -1.119032621383667, -1.1166151762008667, -1.1133546829223633, -1.1092864274978638, -1.104442834854126, -1.0988543033599854, -1.0925488471984863, -1.085552453994751, -1.0778889656066895, -1.0695801973342896, -1.0606460571289062, -1.0511047840118408, -1.0409724712371826, -1.0302635431289673, -1.0189908742904663, -1.0071654319763184, -0.9947967529296875, -0.9818925857543945, -0.9684590101242065, -0.9545007348060608, -0.940020740032196, -0.9250205755233765, -0.9095000624656677, -0.8934575915336609, -0.8768899440765381, -0.8597924113273621, -0.8421585559844971, -0.823980450630188, -0.805248498916626, -0.7859514951705933, -0.766076385974884, -0.7456086277961731, -0.7245317101478577, -0.7028273940086365, -0.6804755330085754, -0.6574540734291077, -0.6337388753890991, -0.6093038320541382, -0.5841206312179565, -0.5581586956977844, -0.5313851833343506, -0.5037647485733032, -0.47525960206985474, -0.44582924246788025, -0.4154304265975952, -0.3840169608592987, -0.3515644967556, -0.318615585565567, -0.2862808406352997, -0.2556975185871124, -0.22800816595554352, -0.20436391234397888, -0.18592798709869385, -0.1738792210817337, -0.1693865954875946, -0.17232953011989594, -0.18078991770744324, -0.19273217022418976, -0.20613117516040802, -0.21896612644195557, -0.22921454906463623, -0.23484621942043304, -0.23382766544818878, -0.22537565231323242, -0.2111511528491974, -0.19308100640773773, -0.17308056354522705, -0.1530594378709793, -0.13492712378501892, -0.12059880048036575, -0.11200101673603058, -0.11107716709375381, -0.11820335686206818, -0.128485769033432, -0.1359400600194931, -0.13457345962524414, -0.11836676299571991, -0.08125641196966171, -0.017116287723183632, -165881.9375, -163300.28125, -160722.609375, -158149.1875, -155580.296875, -153016.234375, -150457.296875, -147903.796875, -145356.0625, -142814.4375, -140279.265625, -137750.9375, -135229.796875, -132716.265625, -130210.7421875, -127713.6796875, -125225.5078125, -122746.703125, -120277.765625, -117819.1953125, -115371.5234375, -112935.3203125, -110511.171875, -108099.671875, -105701.46875, -103317.234375, -100947.65625, -98593.4765625, -96255.4453125, -93934.375, -91631.09375, -89346.484375, -87081.4609375, -84836.984375, -82614.0546875, -80413.7265625, -78237.109375, -76085.3515625, -73959.65625, -71861.3046875, -69791.609375, -67751.96875, -65743.8359375, -63768.7265625, -61828.25, -59924.07421875, -58057.953125, -56231.72265625, -54447.30859375, -52706.7265625, -51012.08984375, -49365.609375, -47769.60546875, -46226.51171875, -44738.87109375, -43309.35546875, -41940.7578125, -40636.0078125, -39398.1796875, -38230.48828125, -37136.3046875, -36119.1640625, -35182.76953125, -34330.99609375, -33567.9140625, -32896.015625, -32310.904296875, -31806.611328125, -31377.341796875, -31017.46875, -30721.517578125, -30484.1484375, -30300.158203125, -30164.455078125, -30072.056640625, -30018.076171875, -29997.705078125, -30006.216796875, -30038.9453125, -30091.275390625, -30158.63671875, -30236.494140625, -30320.33203125, -30405.650390625, -30487.94921875, -30562.7265625, -30625.4609375, -30671.60546875, -30696.57421875, -30695.73828125, -30664.41015625, -30597.837890625, -30491.185546875, -30339.5390625, -30137.875, -29881.06640625, -29563.865234375, -29180.888671875, -28726.607421875, -28195.33984375, -27581.234375, -26878.25390625, -26080.169921875, -25180.541015625, -24172.70703125, -23049.767578125, -21804.568359375, -20429.9921875, -18953.904296875, -17471.765625, -16086.7138671875, -14902.1005859375, -14021.7177734375, -13550.02734375, -13592.388671875, -14255.2900390625, -15646.5849609375, -17875.724609375, -20972.95703125, -24364.76171875, -27204.240234375, -28641.923828125, -27825.267578125, -23896.767578125, -15992.0888671875, -3322.211669921875, -7473.78564453125, -33455.96875, -23129.46875, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -76328.25, -97505.8203125, -1954.57421875, 89423.8125, 7542.529296875, -105149.9453125, -96923.8125, 82786.984375, -48239.71875, -72334.2421875, -93328.8359375, -110969.7734375, 126779.8359375, 120999.4296875, -133908.109375, -98368.4453125, 20869.611328125, -524.8677978515625]
    ffp_target = x[1:nw]
    pp_target = x[nw+1:2*nw]
    fcurrt_target = x[2*nw+7:end]
    ecurrt_target = zeros(6)
    model_name = :d3d_efit01efit02cake02_coils
    green = EGGO.get_greens_function_tables(model_name)
    basis_functions = EGGO.get_basis_functions(model_name)
    basis_functions_1d, bf1d_itp = EGGO.get_basis_functions_1d(model_name)
    wall = EGGO.get_wall(model_name)
    NNmodel = EGGO.get_model(model_name)

    model = NNmodel[:model]

    pp_fit, ffp_fit = EGGO.fit_ppffp(pp_target, ffp_target, basis_functions_1d)

    Jt, psirz, Ip = EGGO.predict_model_from_coils(pp_fit, ffp_fit, ecurrt_target,fcurrt_target, NNmodel, green, basis_functions)
    Ψaxis, Raxis, Zaxis, Ψbnd, ffp,pp = EGGO.get_ΨaxisΨbndffppp(psirz, green, basis_functions,basis_functions_1d, bf1d_itp, wall, pp_fit, ffp_fit)


    # fill out eqt quantities
    dd = IMAS.dd()
    eqt = resize!(dd.equilibrium.time_slice)
    EGGO.fill_eqt(eqt, psirz, green, wall, pp, ffp, b0, r0, pend,Ψbnd,Ψaxis,Raxis,Zaxis)

    @test Jt !== nothing
    @test psirz !== nothing
    @test Ip !== nothing
end



@testset "test_cakenn_free" begin

    # Example diagnostic data
    shot = 168830
    fwtmp2 = [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0]
    fwtsi = [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]

    expsi = [-0.4033802002319999, 0.06076110283043938, 0.10853515679092042, 0.15641445005947727, 0.1660594820489152, -0.11031321378098395, 0.5896888595615067, 0.1753863205962317, 0.088503716473891, -0.006736425708497283, 0.0380201053265609, 0.09299474023561918, 0.18626762407768788, 0.21683726509048587, -0.09977765782429186, -0.10873433915110613, 0.19441311835928618, 0.10148185329008365, 0.011709894683019983, 0.044467497616696994, 0.0923198628231168, 0.1355893842074772, 0.15601260656990892, 0.16695561530681619, 0.0916941833019791, -0.06146592144899354, -0.04386941444183142, -0.15388324682855725, -0.08224239929633187, 0.028333176401003295, 0.07246295585820689, 0.14302804900543153, 0.1965329452133967, 0.20757885694694528, 0.07730990109015949, -0.07111951762372472, -0.044894917507311526, 0.04801603600667154, -0.06804283453097908, 0.168213291249242, 0.1298883611810984, 0.16620308388694635, 0.1388520455946071, 0.10336328686838459]
    expmp2 = [0.5751758217811584, 0.5777432918548584, 0.2995361089706421, 0.5352239012718201, 0.4268638491630554, 0.3233080506324768, 0.17644630372524261, 0.30761346220970154, 0.1082150787115097, 0.2665691375732422, 0.25748637318611145, 0.26021692156791687, 0.29702144861221313, 0.360135555267334, 0.3123251497745514, 0.5910444259643555, 0.39638155698776245, 0.580190896987915, 0.5035938620567322, 0.42172273993492126, 0.2821279466152191, 0.3101239502429962, 0.5534896850585938, 0.23387545347213745, 0.30140069127082825, 0.289532333612442, 0.29198628664016724, 0.3242175579071045, 0.35721850395202637, -0.05749744176864624, -0.010924776084721088, 0.03236999735236168, 0.09824628382921219, 0.12703147530555725, 0.19003534317016602, 0.2579684555530548, 0.2565344572067261, 0.2962685525417328, 0.3557198643684387, 0.3125780522823334, 0.36826983094215393, 0.3251114785671234, 0.3021714389324188, 0.30776268243789673, 0.2574252486228943, 0.13159792125225067, 0.05727966129779816, 0.027812741696834564, -0.0451042503118515, -0.12220883369445801, -0.024340426549315453, 0.24090157449245453, 0.4052409827709198, 0.5804176330566406, 0.5786687135696411, 0.5555588603019714, 0.30065643787384033, 0.13553518056869507, -0.02408536896109581, -0.036081016063690186, -0.041902780532836914, 0.09766237437725067, 0.09371349960565567, 0.08389651775360107, -0.0326533168554306, -0.024524418637156487, -0.5368168950080872, -0.14827822148799896, -0.046501222997903824, -0.05045483633875847, 0.06118004024028778, 0.020677056163549423, 0.0, 0.04194311797618866, 0.06540253013372421, 0.06637807935476303]

    fcurrt = [-249457.546875, -68876.06201171875, -2278.434410095215, 141849.37939453125, 86605.60424804688, -219819.0478515625, -165385.4296875, 114270.47143554688, -21949.81216430664, -265337.65234375, -136116.3427734375, -74327.11328125, 199696.208984375, 200311.96337890625, -214281.10107421875, -206268.06030273438, 77999.93920898438, -21844.74853515625]
    ecurrt = [-41790.4296875, -40929.421875, -41262.1875, -40731.24609375, -41504.9609375, -40838.37109375]

    Ip = 1.2601925881818281e6
    r_tom = [1.9539998769760132, 1.9239999055862427, 1.8903999328613281, 1.830199956893921, 1.7582000494003296, 1.6689000129699707, 1.9936000108718872, 2.0167999267578125, 2.039900064468384, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694, 1.9399999380111694]
    z_tom = [-0.06669999659061432, -0.06520000100135803, -0.06134999915957451, -0.056849997490644455, -0.0539499968290329, -0.043949998915195465, -0.07045000046491623, -0.07169999927282333, -0.07369999587535858, 0.8258000016212463, 0.8137999773025513, 0.8027999401092529, 0.7897999882698059, 0.7767999768257141, 0.7637999653816223, 0.755299985408783, 0.7493000030517578, 0.7437999844551086, 0.7368000149726868, 0.7307999730110168, 0.7247999906539917, 0.7187999486923218, 0.7132999897003174, 0.7062999606132507, 0.7002999782562256, 0.6937999725341797, 0.6873000264167786, 0.6812999844551086, 0.6753000020980835, 0.6683000326156616, 0.6612999439239502, 0.6537999510765076, 0.6482999920845032, 0.6412999629974365, 0.6342999935150146, 0.6243000030517578, 0.6102999448776245, 0.5942999720573425, 0.579800009727478, 0.5637999773025513, 0.5317999720573425, 0.4763000011444092, 0.39229997992515564, 0.3967999815940857, 0.35580000281333923, 0.31779998540878296, 0.26479998230934143, 0.16429999470710754, 0.028800001367926598, 0.10429999977350235, 0.21079999208450317, 0.4383000135421753, 0.4592999815940857, 0.4968000054359436]
    ne_tom = [5.237353434510996e19, 5.065215213480339e19, 4.988054566075577e19, 5.116066306851026e19, 5.278354223110763e19, 4.988761771954563e19, 5.4412974483006554e19, 5.513005837445602e19, 5.554126252910471e19, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.9839893456329114e18, 3.448103649077625e18, 0.0, 0.0, 0.0, 0.0, 1.2463247974840926e19, 2.227819245181128e19, 3.8450814426768474e19, 4.673565653229319e19, 5.5197616766913085e19, 6.171506869757857e19, 5.7428508267484545e19, 5.787191931673405e19, 5.555832255152128e19, 5.5606344821376025e19, 5.6245420561858036e19, 5.76350053472739e19, 5.684361206197282e19, 5.636408865282064e19, 5.587916004450632e19, 5.828891130059135e19, 5.8045431047690125e19, 5.576460412703159e19, 5.749289566840711e19, 5.836300958821043e19, 5.537314720121776e19, 5.396744797338521e19, 5.38293713031691e19, 5.570082365652756e19, 5.302829351945057e19, 4.929878526240647e19, 5.034797884004893e19, 5.598814363705147e19, 5.61634981494957e19, 5.577076139214714e19, 5.554917461477818e19]
    Te_tom = [2388.30078125, 2541.4091796875, 2617.17236328125, 2833.367431640625, 3141.406982421875, 2672.0595703125, 2228.572265625, 1711.920654296875, 1775.5679931640625, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 13.264994621276855, 10.19906997680664, 0.0, 0.0, 0.0, 0.0, 38.132110595703125, 77.92255401611328, 196.4862823486328, 300.4635009765625, 384.357177734375, 403.9305725097656, 469.2989501953125, 531.734375, 528.7698974609375, 523.0098266601562, 662.8626708984375, 624.1710205078125, 621.0045166015625, 703.0703735351562, 728.0448608398438, 761.5218505859375, 813.0936279296875, 818.2413330078125, 1034.0728759765625, 1269.468994140625, 1287.1326904296875, 1405.8865966796875, 1593.55615234375, 1869.154296875, 2035.17236328125, 2447.593505859375, 2391.7333984375, 2011.9029541015625, 1180.7001953125, 1010.9199829101562, 950.290283203125]
    r_cer = [1.9,2.0,2.1]
    z_cer = [0.0,0.0,0.0]
    nc_cer = [1.e19,0.5e19,0.25e19]

    #Get basis functions and green's function tables
    model_name = :d3d_cakenn_free
    green = EGGO.get_greens_function_tables(model_name)
    basis_functions = EGGO.get_basis_functions(model_name)
    basis_functions_1d, bf1d_itp = EGGO.get_basis_functions_1d(model_name)
    wall = EGGO.get_wall(model_name)
    NNmodel = EGGO.get_model(model_name)
    # Predict equilibrium
    y_psi, X = EGGO.predict_psipla_free(shot,expsi,fwtsi,expmp2,fwtmp2,fcurrt,ecurrt,Ip,NNmodel,green,basis_functions)
    y_ne, y_Te, y_nc = EGGO.predict_kinetic(y_psi, r_tom,z_tom,ne_tom,Te_tom,r_cer,z_cer,nc_cer,fcurrt,ecurrt,green,wall,basis_functions,bf1d_itp)

end