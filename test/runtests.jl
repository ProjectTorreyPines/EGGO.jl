using EGGO
using Test
using EGGO.IMAS

nb = 101
nw = 129
b0 = 2.0
r0 = 1.6955
pend = 0.1

@testset "test_efit01efit02cake02" begin
    x = [1.0605924129486084, 1.0608896017074585, 1.0663938522338867, 1.0763258576393127, 1.089898157119751, 1.106051743030548, 1.1222374200820924, 1.1372824311256409, 1.1531906366348266, 1.17087482213974, 1.1853125095367432, 1.2006852149963378, 1.218287706375122, 1.2335846662521361, 1.2507448673248291, 1.2689452767372131, 1.2914233446121215, 1.3205092549324036, 1.355312466621399, 1.403124988079071, 1.4509375095367432, 1.4987500309944153, 1.5359374761581421, 1.5717968702316285, 1.6153075218200683, 1.6565322875976562, 1.6926562309265136, 1.728515648841858, 1.7643750429153442, 1.7995216488838195, 1.8289666175842285, 1.8592872738838195, 1.8945312738418578, 1.9289194464683532, 1.9574405908584596, 1.9888281226158142, 2.019374942779541, 2.044689416885376, 2.0730913639068604, 2.102062153816223, 2.127997398376465, 2.1511905670166014, 2.172341537475586, 2.1916290521621704, 2.2119120597839355, 2.2310010194778442, 2.248103475570679, 2.2624563694000246, 2.2705305576324464, 2.270718479156494, 2.261093854904175, 2.248667073249817, 2.2301867485046385, 2.2133516550064085, 2.192031240463257, 2.170197367668152, 2.149298667907715, 2.126526713371277, 2.101067686080933, 2.073360633850098, 2.048593759536743, 2.02428457736969, 1.990066719055176, 1.9635937929153442, 1.9317187786102294, 1.8995608687400818, 1.8697542905807496, 1.8374218702316285, 1.801562476158142, 1.7658294439315794, 1.7311066389083862, 1.6980594635009767, 1.662781071662903, 1.625009858608246, 1.5871647119522097, 1.5505468845367432, 1.5146875143051148, 1.4788281679153443, 1.4404259204864502, 1.3943384885787966, 1.357968807220459, 1.3221093893051146, 1.280711030960083, 1.260015070438385, 1.2467604875564575, 1.235423743724823, 1.225132942199707, 1.2145055651664733, 1.2027714014053346, 1.1897595405578614, 1.1756504774093628, 1.1607079982757567, 1.1481845140457154, 1.1347704529762268, 1.1197039842605592, 1.1043232083320618, 1.0899749755859376, 1.0775456547737121, 1.067907977104187, 1.061852514743805, 1.0605924129486084, -0.05000000074505806, 0.040000000596046456, 0.11000000014901161, 0.17750000208616257, 0.24500000476837158, 0.3125, 0.3747981011867523, 0.430896681547165, 0.4899999976158142, 0.5560540735721587, 0.6105406284332275, 0.6685540735721588, 0.7350000023841857, 0.7913967251777649, 0.8486552715301514, 0.9000000059604644, 0.9450000166893006, 0.9834775567054749, 1.006093430519104, 1.0171737670898438, 1.0148380994796753, 1.0042214870452881, 0.9928232908248902, 0.9791854500770569, 0.9597741961479187, 0.9393350481987, 0.9192203879356384, 0.8972308874130248, 0.8732836365699768, 0.8478904962539674, 0.824999988079071, 0.7998602330684662, 0.7686789989471436, 0.7359746217727662, 0.7072233438491821, 0.6729281842708587, 0.6372743964195252, 0.6047218382358552, 0.5649999856948852, 0.5199999779462814, 0.4749999940395355, 0.43000001013278966, 0.3850000023841859, 0.3399999916553498, 0.2869778692722322, 0.23081489652395248, 0.1700000017881392, 0.10250000022351731, 0.030000000447035234, -0.05868589170277084, -0.13685891032218933, -0.19368589371442763, -0.26000000536441786, -0.31233201026916513, -0.36999034881591797, -0.423881471157074, -0.4699999928474428, -0.515000003576279, -0.5600000143051144, -0.603956478834152, -0.639564573764801, -0.671456468105316, -0.712974989414215, -0.7432445347309113, -0.7770223259925843, -0.8093024492263794, -0.8374802708625794, -0.866409808397293, -0.8965201258659363, -0.9245087027549745, -0.949999988079071, -0.972500020265579, -0.9950000047683716, -1.0174999833106992, -1.0385538578033446, -1.0576683282852173, -1.0752827644348144, -1.0918086409568786, -1.1081947326660155, -1.126527726650238, -1.1402772665023804, -1.1525838851928711, -1.1658611536026, -1.120651602745056, -1.0549999952316287, -0.9874999821186069, -0.919999992847443, -0.8525000035762789, -0.7850000143051148, -0.7175000190734866, -0.6499999761581421, -0.5824999868869778, -0.527599036693573, -0.46972463130950914, -0.40499999523162844, -0.3375000059604645, -0.27000000476837205, -0.20249999761581458, -0.13500000536441864, -0.07250000275671492, -0.05000000074505806, 1.0857765674591064, 1.0284205675125122, 0.9713146090507507, 0.9148002862930298, 0.8592207431793213, 0.8049219846725464, 0.7522538900375366, 0.7015711069107056, 0.6532343029975891, 0.6076111197471619, 0.5650774836540222, 0.5260182619094849, 0.4908289909362793, 0.4599166512489319, 0.43369922041893005, 0.41235318779945374, 0.39555004239082336, 0.3829119801521301, 0.3740735650062561, 0.36868077516555786, 0.36638984084129333, 0.3668663501739502, 0.3697841167449951, 0.37482425570487976, 0.38167428970336914, 0.3900270462036133, 0.3995799720287323, 0.4100340008735657, 0.42109283804893494, 0.4324619472026825, 0.44384774565696716, 0.45495671033859253, 0.46549442410469055, 0.47516486048698425, 0.48366934061050415, 0.49070578813552856, 0.49606043100357056, 0.49978339672088623, 0.5019684433937073, 0.5027046799659729, 0.5020768642425537, 0.5001658201217651, 0.49704840779304504, 0.4927978515625, 0.48748406767845154, 0.4811737537384033, 0.4739306569099426, 0.4658156633377075, 0.4568871557712555, 0.4472009837627411, 0.43681076169013977, 0.42576804757118225, 0.4141223728656769, 0.4019215404987335, 0.38921162486076355, 0.37603721022605896, 0.3624414801597595, 0.3484663665294647, 0.3341526687145233, 0.3195401728153229, 0.30466774106025696, 0.2895735204219818, 0.2742949426174164, 0.25886887311935425, 0.24333181977272034, 0.22771987318992615, 0.21206894516944885, 0.1964147984981537, 0.18079321086406708, 0.16524004936218262, 0.1497914046049118, 0.13448365032672882, 0.11935358494520187, 0.10443856567144394, 0.08977656811475754, 0.07540633529424667, 0.061367470771074295, 0.047700587660074234, 0.03444739803671837, 0.021650854498147964, 0.009355278685688972, -0.0023935085628181696, -0.013548054732382298, -0.024059128016233444, -0.03387556970119476, -0.04294414818286896, -0.05120938643813133, -0.05861341208219528, -0.06509577482938766, -0.07059326022863388, -0.07503972202539444, -0.07836585491895676, -0.08049900829792023, -0.08136296272277832, -0.08087770640850067, -0.07895918190479279, -0.07551905512809753, -0.07046442478895187, -0.06369758397340775, -0.055115677416324615, -0.044610437005758286, -0.032067835330963135, -0.01736775040626526, -0.0003836085379589349, 0.019017966464161873, 0.040854938328266144, 0.06475464999675751, 0.09027009457349777, 0.1169590875506401, 0.14438295364379883, 0.17210529744625092, 0.20026656985282898, 0.23097722232341766, 0.2667753994464874, 0.31021445989608765, 0.36387065052986145, 0.4303506910800934, 0.5099472999572754, 0.5945207476615906, 0.6740403771400452, 0.7384603023529053, 0.7778705358505249, 0.7868070602416992, 0.7644423842430115, 0.7100776433944702, 0.6229183077812195, 0.5020718574523926, 0.3465448319911957, 0.15524010360240936, -646553.8125, -646369.25, -646128.125, -645831.125, -645478.8125, -645071.5, -644609.4375, -644092.875, -643521.8125, -642896.125, -642215.625, -641479.9375, -640688.6875, -639841.25, -638937.0, -637975.0, -636954.3125, -635874.0, -634732.6875, -633529.125, -632261.8125, -630929.125, -629529.3125, -628060.5, -626520.5, -624907.25, -623218.25, -621451.0, -619602.75, -617670.6875, -615651.625, -613542.375, -611339.375, -609039.0625, -606637.5, -604130.5625, -601513.875, -598782.9375, -595932.8125, -592958.5, -589854.5625, -586615.375, -583234.9375, -579707.0625, -576025.0625, -572182.125, -568170.9375, -563983.75, -559612.6875, -555049.1875, -550284.375, -545309.0625, -540113.375, -534687.125, -529019.5, -523099.21875, -516914.46875, -510452.8125, -503701.1875, -496645.96875, -489272.78125, -481566.5625, -473511.59375, -465091.3125, -456288.40625, -447094.40625, -437539.0, -427660.84375, -417497.8125, -407087.28125, -396465.9375, -385670.125, -374735.71875, -363698.34375, -352593.34375, -341455.96875, -330321.40625, -319224.75, -308201.3125, -297286.5, -286515.90625, -275925.53125, -265551.75, -255431.34375, -245601.765625, -236101.015625, -226967.859375, -218241.859375, -209963.453125, -202174.109375, -194916.328125, -188233.796875, -182171.453125, -176775.625, -172094.09375, -168176.171875, -165072.921875, -162837.125, -161523.53125, -161188.859375, -161892.03125, -163694.203125, -166659.0, -170852.546875, -176343.703125, -183204.171875, -191508.65625, -201335.046875, -212764.578125, -225882.0, -240775.765625, -257538.25, -276265.90625, -297059.5625, -320075.03125, -347433.625, -383811.0625, -434072.6875, -503114.34375, -595756.125, -680025.1875, -686378.0, -655908.5625, -602309.0625, -529506.375, -441385.25, -341796.59375, -234566.328125, -123503.3984375, 3648.6083984375]
    Rb_target = x[1:nb]
    Zb_target = x[nb+1:2*nb]
    Rb_target[end] = Rb_target[1]
    Zb_target[end] = Zb_target[1]
    ffp_target = x[2*nb+1:2*nb+nw]
    pp_target = x[2*nb+nw+1:2*nb+2*nw]

    model_name = :d3d_efit01efit02cake02
    green = EGGO.get_greens_function_tables(model_name)
    basis_functions = EGGO.get_basis_functions(model_name)
    basis_functions_1d, bf1d_itp = EGGO.get_basis_functions_1d(model_name)
    wall = EGGO.get_wall(model_name)
    NNmodel = EGGO.get_model(model_name)
    model = NNmodel[:model]
    coils = nothing 
    Ip_target = 0.0
    use_vacuum_fields = false
    
    pp_fit, ffp_fit = EGGO.fit_ppffp(pp_target, ffp_target, basis_functions_1d)
    
    Jt,psirz, Ip = EGGO.predict_model_from_boundary(Rb_target,Zb_target,pp_fit,ffp_fit,NNmodel, green, basis_functions,coils,Ip_target,use_vacuum_fields)
    
    Ψaxis, Raxis, Zaxis, Ψbnd, ffp, pp = EGGO.get_ΨaxisΨbndffppp(psirz, green, basis_functions,basis_functions_1d, bf1d_itp, wall, pp_fit, ffp_fit)
    dd = IMAS.dd()
    eqt = resize!(dd.equilibrium.time_slice)
    EGGO.fill_eqt(eqt, psirz, green, wall, pp, ffp, b0, r0, pend,Ψbnd,Ψaxis,Raxis,Zaxis)

    @test Jt !== nothing
    @test psirz !== nothing
    @test Ip !== nothing
end


@testset "test_efit01efit02cake02_coils" begin
    x = [-2.6756629943847656, -2.53544282913208, -2.395742177963257, -2.2573087215423584, -2.120894193649292, -1.9872558116912842, -1.8571596145629883, -1.7313822507858276, -1.610713005065918, -1.4959566593170166, -1.3879354000091553, -1.287492036819458, -1.1954915523529053, -1.1128244400024414, -1.0404092073440552, -0.9790046811103821, -0.9282169938087463, -0.8872273564338684, -0.8552453517913818, -0.8315075635910034, -0.8152751326560974, -0.805831789970398, -0.802481472492218, -0.8045463562011719, -0.8113648891448975, -0.8222895860671997, -0.8366854786872864, -0.853927731513977, -0.8734002709388733, -0.8944934010505676, -0.916602611541748, -0.9391261339187622, -0.9614635705947876, -0.9830140471458435, -1.0031741857528687, -1.0214844942092896, -1.0379505157470703, -1.0526666641235352, -1.0657213926315308, -1.07719886302948, -1.0871779918670654, -1.0957335233688354, -1.102935791015625, -1.1088510751724243, -1.1135419607162476, -1.1170670986175537, -1.1194820404052734, -1.1208387613296509, -1.1211860179901123, -1.1205697059631348, -1.119032621383667, -1.1166151762008667, -1.1133546829223633, -1.1092864274978638, -1.104442834854126, -1.0988543033599854, -1.0925488471984863, -1.085552453994751, -1.0778889656066895, -1.0695801973342896, -1.0606460571289062, -1.0511047840118408, -1.0409724712371826, -1.0302635431289673, -1.0189908742904663, -1.0071654319763184, -0.9947967529296875, -0.9818925857543945, -0.9684590101242065, -0.9545007348060608, -0.940020740032196, -0.9250205755233765, -0.9095000624656677, -0.8934575915336609, -0.8768899440765381, -0.8597924113273621, -0.8421585559844971, -0.823980450630188, -0.805248498916626, -0.7859514951705933, -0.766076385974884, -0.7456086277961731, -0.7245317101478577, -0.7028273940086365, -0.6804755330085754, -0.6574540734291077, -0.6337388753890991, -0.6093038320541382, -0.5841206312179565, -0.5581586956977844, -0.5313851833343506, -0.5037647485733032, -0.47525960206985474, -0.44582924246788025, -0.4154304265975952, -0.3840169608592987, -0.3515644967556, -0.318615585565567, -0.2862808406352997, -0.2556975185871124, -0.22800816595554352, -0.20436391234397888, -0.18592798709869385, -0.1738792210817337, -0.1693865954875946, -0.17232953011989594, -0.18078991770744324, -0.19273217022418976, -0.20613117516040802, -0.21896612644195557, -0.22921454906463623, -0.23484621942043304, -0.23382766544818878, -0.22537565231323242, -0.2111511528491974, -0.19308100640773773, -0.17308056354522705, -0.1530594378709793, -0.13492712378501892, -0.12059880048036575, -0.11200101673603058, -0.11107716709375381, -0.11820335686206818, -0.128485769033432, -0.1359400600194931, -0.13457345962524414, -0.11836676299571991, -0.08125641196966171, -0.017116287723183632, -165881.9375, -163300.28125, -160722.609375, -158149.1875, -155580.296875, -153016.234375, -150457.296875, -147903.796875, -145356.0625, -142814.4375, -140279.265625, -137750.9375, -135229.796875, -132716.265625, -130210.7421875, -127713.6796875, -125225.5078125, -122746.703125, -120277.765625, -117819.1953125, -115371.5234375, -112935.3203125, -110511.171875, -108099.671875, -105701.46875, -103317.234375, -100947.65625, -98593.4765625, -96255.4453125, -93934.375, -91631.09375, -89346.484375, -87081.4609375, -84836.984375, -82614.0546875, -80413.7265625, -78237.109375, -76085.3515625, -73959.65625, -71861.3046875, -69791.609375, -67751.96875, -65743.8359375, -63768.7265625, -61828.25, -59924.07421875, -58057.953125, -56231.72265625, -54447.30859375, -52706.7265625, -51012.08984375, -49365.609375, -47769.60546875, -46226.51171875, -44738.87109375, -43309.35546875, -41940.7578125, -40636.0078125, -39398.1796875, -38230.48828125, -37136.3046875, -36119.1640625, -35182.76953125, -34330.99609375, -33567.9140625, -32896.015625, -32310.904296875, -31806.611328125, -31377.341796875, -31017.46875, -30721.517578125, -30484.1484375, -30300.158203125, -30164.455078125, -30072.056640625, -30018.076171875, -29997.705078125, -30006.216796875, -30038.9453125, -30091.275390625, -30158.63671875, -30236.494140625, -30320.33203125, -30405.650390625, -30487.94921875, -30562.7265625, -30625.4609375, -30671.60546875, -30696.57421875, -30695.73828125, -30664.41015625, -30597.837890625, -30491.185546875, -30339.5390625, -30137.875, -29881.06640625, -29563.865234375, -29180.888671875, -28726.607421875, -28195.33984375, -27581.234375, -26878.25390625, -26080.169921875, -25180.541015625, -24172.70703125, -23049.767578125, -21804.568359375, -20429.9921875, -18953.904296875, -17471.765625, -16086.7138671875, -14902.1005859375, -14021.7177734375, -13550.02734375, -13592.388671875, -14255.2900390625, -15646.5849609375, -17875.724609375, -20972.95703125, -24364.76171875, -27204.240234375, -28641.923828125, -27825.267578125, -23896.767578125, -15992.0888671875, -3322.211669921875, -7473.78564453125, -33455.96875, -23129.46875, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -76328.25, -97505.8203125, -1954.57421875, 89423.8125, 7542.529296875, -105149.9453125, -96923.8125, 82786.984375, -48239.71875, -72334.2421875, -93328.8359375, -110969.7734375, 126779.8359375, 120999.4296875, -133908.109375, -98368.4453125, 20869.611328125, -524.8677978515625]
    ffp_target = x[1:nw]
    pp_target = x[nw+1:2*nw]
    fcurrt_target = x[2*nw+7:end]
    ecurrt_target = zeros(6)
    model_name = :d3d_efit01efit02cake02_coils
    green = EGGO.get_greens_function_tables(model_name)
    basis_functions = EGGO.get_basis_functions(model_name)
    basis_functions_1d, bf1d_itp = EGGO.get_basis_functions_1d(model_name)
    wall = EGGO.get_wall(model_name)
    NNmodel = EGGO.get_model(model_name)

    model = NNmodel[:model]

    pp_fit, ffp_fit = EGGO.fit_ppffp(pp_target, ffp_target, basis_functions_1d)

    Jt, psirz, Ip = EGGO.predict_model_from_coils(pp_fit, ffp_fit, ecurrt_target,fcurrt_target, NNmodel, green, basis_functions)
    Ψaxis, Raxis, Zaxis, Ψbnd, ffp,pp = EGGO.get_ΨaxisΨbndffppp(psirz, green, basis_functions,basis_functions_1d, bf1d_itp, wall, pp_fit, ffp_fit)


    # fill out eqt quantities
    dd = IMAS.dd()
    eqt = resize!(dd.equilibrium.time_slice)
    EGGO.fill_eqt(eqt, psirz, green, wall, pp, ffp, b0, r0, pend,Ψbnd,Ψaxis,Raxis,Zaxis)

    @test Jt !== nothing
    @test psirz !== nothing
    @test Ip !== nothing
end

