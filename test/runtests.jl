using EGGO
using Test
using EGGO.IMAS

x = [1.09559171, 1.0997446376, 1.1070618348, 1.1175362682999999, 1.1308035831999999, 1.1462708645, 1.1618525741999999, 1.1748229521, 1.1938695924, 1.208962951, 1.226595503, 1.2436285322, 1.2603981636, 1.2776812111, 1.2946356166, 1.309698407, 1.3281952508, 1.3415813081, 1.354473056, 1.3868513145, 1.43234375, 1.4749765625, 1.5115, 1.5575859375, 1.59225, 1.629264015, 1.6710031426, 1.7095234375, 1.7441875, 1.7788515625, 1.8135156250000002, 1.8481796875, 1.88284375, 1.9175078125, 1.945799357, 1.97481647, 2.0056947116, 2.0339704028, 2.06346875, 2.086578125, 2.1096875, 2.1327968750000004, 2.15590625, 2.179015625, 2.2001536684, 2.217257788, 2.2349671081999998, 2.2539269399000004, 2.2700427984, 2.2831342743, 2.29447733, 2.3007727865, 2.2985730319999997, 2.28932236, 2.27537713, 2.26318817, 2.24475263, 2.2282805774999996, 2.2090312500000002, 2.1878476362000003, 2.1694483840000003, 2.149598575, 2.12721739, 2.1014536774, 2.072722168, 2.047265625, 2.0185781249999994, 1.9873986125999998, 1.9614681795999998, 1.9278671875, 1.8932031249999999, 1.8585390625000002, 1.8238750000000001, 1.7865177448, 1.7462259225999999, 1.7066015625, 1.6703437499999998, 1.6241249999999996, 1.5779062499999996, 1.5316874999999999, 1.48546875, 1.4454921874999997, 1.4108281249999997, 1.3780797244999998, 1.351107168, 1.3217171325, 1.2978439504, 1.2767148960999999, 1.2573982568000002, 1.2381546668, 1.2177480379999999, 1.1975857947, 1.182617962, 1.1625175254999998, 1.1487620224, 1.134547034, 1.121177226, 1.1101826154, 1.1018582046, 1.0962396599, 1.09559171, 0.0, 0.08700000000000001, 0.1555, 0.22075, 0.28600000000000003, 0.35099467675, 0.4104309939, 0.45675000000000004, 0.522, 0.57218528669, 0.6295549229, 0.6848864054, 0.7392743632, 0.79590334712, 0.8527927246400001, 0.90375, 0.969, 1.0186794792, 1.0682557061999998, 1.0800915083, 1.067447848, 1.0555178317, 1.0444215632, 1.0298720099, 1.0179782311999999, 1.0040844275, 0.98708481596, 0.9699926525799999, 0.9528818285199999, 0.93403012572, 0.9132756059999999, 0.8903396655, 0.86469505932, 0.8363221227999998, 0.81120005558, 0.78280078805, 0.75001007972, 0.71655532232, 0.6782200468399999, 0.6443729700199998, 0.6065020579999999, 0.5642903279599999, 0.51716010578, 0.46468993953000004, 0.4122795048000001, 0.3663453183, 0.3159560795599999, 0.2574032334199997, 0.20136560271999993, 0.14757272764, 0.07500000000000023, 0.003888867154000171, -0.054363408007999894, -0.13325000000000006, -0.1985000000000002, -0.24374816975000022, -0.30441116180000044, -0.3550996140500004, -0.40947549072, -0.4656649635900001, -0.5100000000000001, -0.5534999999999999, -0.5969999999999999, -0.6405, -0.6828329336800001, -0.7163802308000001, -0.7491309296600003, -0.7814770833500002, -0.8051318419200003, -0.83292756801, -0.8576806923000001, -0.8792819401699999, -0.8981352902399999, -0.91548856884, -0.9313817735800001, -0.94447484125, -0.9537477083200001, -0.9626707641400001, -0.96699025372, -0.96659880543, -0.959736525, -0.9473212784099999, -0.9282227074599998, -0.9017757330699997, -0.871, -0.8274999999999999, -0.7839999999999998, -0.7405, -0.6970000000000002, -0.6503358114600001, -0.5973489954, -0.5414999999999999, -0.49699999999999966, -0.4317499999999995, -0.3823828279999995, -0.32462690999999927, -0.26099999999999984, -0.19574999999999998, -0.12400000000000036, -0.043500000000000094, 0.0, -2.8693022500000005, -2.83117579, -2.79329281, -2.7556533, -2.71825727, -2.68110472, -2.64419565, -2.60753006, -2.57110794, -2.5349293, -2.49899413, -2.46330245, -2.42785424, -2.3926495, -2.35768825, -2.32297047, -2.28849617, -2.25426535, -2.220278, -2.18653413, -2.1530337400000006, -2.11977683, -2.08676339, -2.05399343, -2.02146695, -1.9891839400000002, -1.95714441, -1.92534836, -1.8937957900000002, -1.86248669, -1.8314210700000002, -1.8005989300000003, -1.77002026, -1.7396850800000003, -1.70959337, -1.6797451299999997, -1.65014038, -1.6207791, -1.5916613, -1.56278697, -1.53415612, -1.50576875, -1.47762486, -1.44972445, -1.42206751, -1.39465405, -1.36748406, -1.34055756, -1.31387453, -1.28743497, -1.2612389, -1.2352863, -1.20957718, -1.18411154, -1.15888937, -1.13391068, -1.10917547, -1.08468374, -1.06043548, -1.0364307, -1.0126694, -0.9891515710000001, -0.965877223, -0.942846352, -0.9200589580000001, -0.8975150420000001, -0.875214602, -0.8531576399999999, -0.831344155, -0.809774148, -0.7884476170000001, -0.767364564, -0.746524988, -0.725928889, -0.705576268, -0.685467123, -0.665601456, -0.645979266, -0.626600554, -0.607465318, -0.58857356, -0.569925279, -0.551520475, -0.533359149, -0.5154413, -0.4977669270000001, -0.480336033, -0.463148615, -0.44620467500000005, -0.429504211, -0.413047225, -0.396833717, -0.380863685, -0.365137131, -0.349654054, -0.334414454, -0.319418331, -0.304665686, -0.290156518, -0.275890827, -0.261868613, -0.248089877, -0.234554618, -0.221262836, -0.20821453100000004, -0.195409703, -0.182848353, -0.17053048, -0.158456084, -0.146625165, -0.135037724, -0.123693759, -0.11259327199999998, -0.101736263, -0.09112273, -0.0807526747, -0.0706260966, -0.06074299570000001, -0.0511033721, -0.0417072256, -0.0325545564, -0.0236453645, -0.0149796497, -0.00655741217, 0.00162134814, 0.00955663122, 0.0172484371, 0.0246967657, 0.0319016171, -251684.349, -249894.236, -248104.12200000003, -246314.008, -244523.894, -242733.781, -240943.667, -239153.553, -237363.43999999997, -235573.326, -233783.212, -231993.09799999997, -230202.98500000002, -228412.871, -226622.75700000004, -224832.644, -223042.53000000003, -221252.416, -219462.303, -217672.189, -215882.07499999998, -214091.961, -212301.848, -210511.734, -208721.62000000002, -206931.50700000004, -205141.39300000004, -203351.279, -201561.165, -199771.052, -197980.938, -196190.824, -194400.711, -192610.597, -190820.483, -189030.369, -187240.25600000002, -185450.142, -183660.028, -181869.915, -180079.801, -178289.687, -176499.573, -174709.46, -172919.346, -171129.232, -169339.119, -167549.005, -165758.891, -163968.777, -162178.664, -160388.55, -158598.436, -156808.323, -155018.209, -153228.095, -151437.981, -149647.868, -147857.754, -146067.64, -144277.527, -142487.413, -140697.299, -138907.186, -137117.072, -135326.958, -133536.844, -131746.731, -129956.617, -128166.503, -126376.39, -124586.27600000001, -122796.162, -121006.048, -119215.935, -117425.82100000001, -115635.707, -113845.594, -112055.48000000001, -110265.366, -108475.252, -106685.139, -104895.02500000001, -103104.911, -101314.798, -99524.6839, -97734.5702, -95944.4564, -94154.3427, -92364.229, -90574.1153, -88784.0016, -86993.8879, -85203.7742, -83413.6605, -81623.54680000001, -79833.433, -78043.3193, -76253.2056, -74463.0919, -72672.9782, -70882.8645, -69092.7508, -67302.6371, -65512.5234, -63722.4096, -61932.29589999999, -60142.1822, -58352.06850000001, -56561.95480000001, -54771.8411, -52981.72740000001, -51191.6137, -49401.5, -47611.3862, -45821.2725, -44031.1588, -42241.0451, -40450.9314, -38660.8177, -36870.704, -35080.5903, -33290.4766, -31500.3628, -29710.2491, -27920.135400000003, -26130.021700000005, -24339.908, -22549.7943, -10483.764092115976, -10406.591562771071, -10380.03968422253, -10245.780286354311, -10841.642475001427, -10303.48090229303]
nb = 101
nw = 129
Rb_target = x[1:nb]
Zb_target = x[nb+1:2*nb]
ffp_target = x[2*nb+1:2*nb+nw]
pp_target = x[2*nb+nw+1:2*nb+2*nw]
ecurrt_target = x[2*nb+2*nw+1:end]
Btcenter = 2.0
Rcenter = 1.6955
pend = 0.1

@testset "test_efit01" begin
    model_name = :d3d_efit01
    basis_functions_1d, bf1d_itp = EGGO.get_basis_functions_1d(model_name)
    green = EGGO.get_greens_function_tables(model_name)
    basis_functions = EGGO.get_basis_functions(model_name)

    wall = EGGO.get_wall(model_name)
    NNmodel = EGGO.get_model(model_name)
    model = NNmodel[:model]

    Jt, psirz, Ip, fcurrt = EGGO.predict_model(Rb_target, Zb_target, pp_target, ffp_target, ecurrt_target, NNmodel, green, basis_functions, basis_functions_1d)

    dd = IMAS.dd()
    eqt = resize!(dd.equilibrium.time_slice)
    EGGO.fill_eqt(eqt, psirz, green, wall, pp_target, ffp_target, Btcenter, Rcenter, pend)
    IMAS.flux_surfaces(eqt, wall[:rlim], wall[:zlim])

    @test Jt !== nothing
    @test psirz !== nothing
    @test Ip !== nothing
    @test fcurrt !== nothing
end
